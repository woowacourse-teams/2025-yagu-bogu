name: YaguBogu Backend Dev (smoke-ci)

on:
  push:
    branches: [ "smoke-ci" ]
    paths:
      - "backend/**"
      - "k6/**"
  workflow_dispatch:

env:
  IMAGE: yagubogu/yagubogu-backend

jobs:
  ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./backend
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Tests
        run: ./gradlew test

  smoke:
    needs: ci
    runs-on: ubuntu-latest
    continue-on-error: true   # ğŸ”¸ ìŠ¤ëª¨í¬ê°€ ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ë¹¨ê°›ê²Œ ì•ˆ ê¹¨ì§
    steps:
      - uses: actions/checkout@v4

      - name: Run k6 smoke test on core APIs (via Docker)
        working-directory: ./k6
        env:
          # ì—¬ê¸° BASE_URLì„ ì‹¤ì œë¡œ í˜¸ì¶œí•´ë³¼ ì„œë²„ë¡œ ë°”ê¿”ì¤˜ë„ ë¨
          # ì˜ˆ: dev ì„œë²„: "http://43.203.246.80:80"
          BASE_URL: "http://43.203.246.80:80"
          AUTH_TOKEN: ${{ secrets.SMOKE_AUTH_TOKEN }}
          GAME_ID: "2"
          MEMBER_ID: "2"
          YEAR: "2025"
          DATE: "2025-05-25"
          DISCORD_WEBHOOK_BE: ${{ secrets.DISCORD_WEBHOOK_BE }}
        run: |
          docker run --rm \
            -e BASE_URL="$BASE_URL" \
            -e AUTH_TOKEN="$AUTH_TOKEN" \
            -e GAME_ID="$GAME_ID" \
            -e MEMBER_ID="$MEMBER_ID" \
            -e YEAR="$YEAR" \
            -e DATE="$DATE" \
            -e DISCORD_WEBHOOK_BE="$DISCORD_WEBHOOK_BE" \
            -v "$PWD":/scripts \
            grafana/k6 \
            run /scripts/smoke_core_apis.js
