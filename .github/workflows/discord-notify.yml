name: Discord PR Notification

on:
  pull_request:
    types: [ opened, synchronize, closed ]

jobs:
  # dev-be, dev-an ëŒ€ìƒ PR ì•Œë¦¼
  notify-discord:
    runs-on: ubuntu-latest
    if: "!(github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base_ref == 'dev')"
    steps:
      - name: Set Discord Webhook & Mention
        id: meta
        run: |
          BRANCH="${{ github.base_ref }}"
          case "$BRANCH" in
            dev-be*)
              echo "url=${{ secrets.DISCORD_WEBHOOK_BE }}" >> "$GITHUB_OUTPUT"
              echo "mention=<@&1395631364199682048>" >> "$GITHUB_OUTPUT"
              ;;
            dev-an*)
              echo "url=${{ secrets.DISCORD_WEBHOOK_AN }}" >> "$GITHUB_OUTPUT"
              echo "mention=<@&1395631119700983970>" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "url=" >> "$GITHUB_OUTPUT"
              echo "mention=" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Compose PR Notification Message
        id: message
        run: |
          ACTION="${{ github.event.action }}"
          MERGED="${{ github.event.pull_request.merged }}"
          TITLE="${{ github.event.pull_request.title }}"
          URL="${{ github.event.pull_request.html_url }}"
          COMMITS="${{ github.event.pull_request.commits }}"
          FILES="${{ github.event.pull_request.changed_files }}"
          ADD="${{ github.event.pull_request.additions }}"
          DEL="${{ github.event.pull_request.deletions }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          NUMBER="${{ github.event.number }}"
          ACTOR="${{ github.actor }}"
          LABELS=$(jq -r '.pull_request.labels | map(.name) | join(", ")' <<< '${{ toJson(github.event) }}')
          if [[ -z "$LABELS" ]]; then
            LABEL_LINE=""
          else
            LABEL_LINE="ğŸ“› ë¼ë²¨: $LABELS"
          fi
          case "$ACTION" in
            opened)
              EVENT_MSG="ğŸ“Œ ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
              ;;
            synchronize)
              EVENT_MSG="ğŸ“¦ PRì— ì»¤ë°‹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"
              ;;
            closed)
              if [[ "$MERGED" == "true" ]]; then
                EVENT_MSG="âœ… PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
              else
                EVENT_MSG="âŒ PRì´ ë‹«í˜”ì§€ë§Œ ë¨¸ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              fi
              ;;
            *)
              EVENT_MSG="â„¹ï¸ PR ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
              ;;
          esac
          {
            echo 'msg_body<<EOF'
            printf "%s\n#ï¸âƒ£ PR #%sÂ  |Â  ğŸŒ¿ ë¸Œëœì¹˜: %s â†’ %s\nğŸ“ ì»¤ë°‹: %sÂ  |Â  íŒŒì¼: %sÂ  |Â  +%s / -%s\nğŸ”– ì œëª©: %s\n%s\nğŸ™‹ ì‘ì„±ì: %s\nğŸ”— %s" \
              "$EVENT_MSG" "$NUMBER" "$HEAD" "$BASE" "$COMMITS" "$FILES" "$ADD" "$DEL" "$TITLE" "$LABEL_LINE" "$ACTOR" "$URL"
            echo ''
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Send Discord Notification
        if: steps.meta.outputs.url != ''
        run: |
          MENTION="${{ steps.meta.outputs.mention }}"
          MSG_BODY="${{ steps.message.outputs.msg_body }}"
          
          # â­ï¸ [ë³€ê²½] '\n' ëŒ€ì‹  ì‹¤ì œ ì¤„ë°”ê¿ˆì„ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ í• ë‹¹
          FINAL_CONTENT="${MENTION}
          ${MSG_BODY}"
          
          JSON_PAYLOAD=$(jq -n --arg content "$FINAL_CONTENT" '{content: $content}')
          
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ steps.meta.outputs.url }}"

  # dev ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ AN, BE íŒ€ ëª¨ë‘ì—ê²Œ ì•Œë¦¼
  notify-dev-merge:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base_ref == 'dev'
    steps:
      - name: Compose Dev Merge Notification Message
        id: message
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          URL="${{ github.event.pull_request.html_url }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          NUMBER="${{ github.event.number }}"
          ACTOR="${{ github.actor }}"
          EVENT_MSG="ğŸ‰ **dev** ë¸Œëœì¹˜ì— ìƒˆë¡œìš´ ì½”ë“œê°€ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
          MENTION_BE="<@&1395631364199682048>"
          MENTION_AN="<@&1395631119700983970>"
          
          MSG_BODY=$(printf "%s\n#ï¸âƒ£ PR #%s: %s\nğŸŒ¿ ë¸Œëœì¹˜: %s â†’ **%s**\nğŸ™‹ ë¨¸ì§€í•œ ì‚¬ëŒ: %s\nğŸ”— %s" \
            "$EVENT_MSG" "$NUMBER" "$TITLE" "$HEAD" "$BASE" "$ACTOR" "$URL")

          echo "msg_body=$MSG_BODY" >> "$GITHUB_OUTPUT"
          echo "mention_be=$MENTION_BE" >> "$GITHUB_OUTPUT"
          echo "mention_an=$MENTION_AN" >> "$GITHUB_OUTPUT"

      - name: Send Notification to BE Team
        run: |
          FINAL_CONTENT="${{ steps.message.outputs.mention_be }}
          ${{ steps.message.outputs.msg_body }}"
          JSON_PAYLOAD=$(jq -n --arg content "$FINAL_CONTENT" '{content: $content}')
          curl -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "${{ secrets.DISCORD_WEBHOOK_BE }}"

      - name: Send Notification to AN Team
        run: |
          FINAL_CONTENT="${{ steps.message.outputs.mention_an }}
          ${{ steps.message.outputs.msg_body }}"
          JSON_PAYLOAD=$(jq -n --arg content "$FINAL_CONTENT" '{content: $content}')
          curl -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "${{ secrets.DISCORD_WEBHOOK_AN }}"
