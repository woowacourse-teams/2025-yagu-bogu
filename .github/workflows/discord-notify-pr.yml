name: Discord PR Notification

on:
  pull_request:
    types: [ review_requested, opened, reopened, ready_for_review ]

jobs:
  notify:
    # Draft PR ì œì™¸
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest

    steps:
      - name: Decide webhook by base branch
        id: route
        shell: bash
        run: |
          BASE="${{ github.event.pull_request.base.ref }}"

          # ë¸Œëœì¹˜ â†’ ì›¹í›… ë§¤í•‘
          case "$BASE" in
            dev-be) WEBHOOK="${{ secrets.DISCORD_WEBHOOK_BE }}";;
            dev-an) WEBHOOK="${{ secrets.DISCORD_WEBHOOK_AN }}";;
            *) WEBHOOK="";;
          esac

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          [ -n "$WEBHOOK" ] && echo "webhook=$WEBHOOK" >> "$GITHUB_OUTPUT"

          # ì´ë²¤íŠ¸/ë¦¬ë·°ì–´(ê°œì¸/íŒ€) ì¶”ì¶œ: review_requested ì´ë²¤íŠ¸ì—ì„œë§Œ ì¡´ì¬
          ACTION="${{ github.event.action }}"
          REQ_USER="${{ github.event.requested_reviewer.login }}"
          REQ_TEAM="${{ github.event.requested_team.slug }}"

          if [ -n "$REQ_USER" ]; then
            REQUESTED="$REQ_USER"
          elif [ -n "$REQ_TEAM" ]; then
            REQUESTED="team/${REQ_TEAM}"
          else
            REQUESTED=""
          fi

          echo "action=$ACTION" >> "$GITHUB_OUTPUT"
          echo "requested=$REQUESTED" >> "$GITHUB_OUTPUT"

          # ê³µí†µ ë©”ì‹œì§€ í•„ë“œ (PR ì œëª©ì€ ë©€í‹°ë¼ì¸ ì•ˆì „ ì²˜ë¦¬)
          {
            echo "pr_number=${{ github.event.pull_request.number }}"
            echo "pr_title<<EOF"
            echo "${{ github.event.pull_request.title }}"
            echo "EOF"
            echo "pr_url=${{ github.event.pull_request.html_url }}"
            echo "sender=${{ github.actor }}"
            echo "head=${{ github.event.pull_request.head.ref }}"
          } >> "$GITHUB_OUTPUT"

      - name: Skip if base branch is not mapped
        if: ${{ steps.route.outputs.webhook == '' }}
        run: echo "No target webhook for base=${{ steps.route.outputs.base }}. Skipping."

      - name: Build Discord payload
        if: ${{ steps.route.outputs.webhook != '' }}
        shell: bash
        run: |
          # ì´ë²¤íŠ¸ë³„ íƒ€ì´í‹€/ì¶”ê°€ ì„¤ëª…
          case "${{ steps.route.outputs.action }}" in
            review_requested)
              TITLE="ğŸ”” Review Requested"
              if [ -n "${{ steps.route.outputs.requested }}" ]; then
                EXTRA=$'\n''ğŸ‘€ Requested reviewer: `'"${{ steps.route.outputs.requested }}"'`'
              else
                EXTRA=""
              fi
              ;;
            opened)           TITLE="ğŸ“Œ PR Opened";      EXTRA="";;
            reopened)         TITLE="ğŸ“Œ PR Reopened";    EXTRA="";;
            ready_for_review) TITLE="âœ… Ready for Review"; EXTRA="";;
            *)                TITLE="PR Event";          EXTRA="";;
          esac

          # ë³¸ë¬¸(Discord embed description)
          DESC="**#${{ steps.route.outputs.pr_number }}** ${{ steps.route.outputs.pr_title }}
          by \`${{ steps.route.outputs.sender }}\`
          base: \`${{ steps.route.outputs.base }}\` â† head: \`${{ steps.route.outputs.head }}\`
          ğŸ”— ${{ steps.route.outputs.pr_url }}${EXTRA}"

          # JSON ìƒì„± (jq í•„ìš”)
          jq -n --arg t "$TITLE" --arg d "$DESC" \
            '{embeds:[{title:$t, description:$d}]}' > payload.json

      - name: Send to Discord
        if: ${{ steps.route.outputs.webhook != '' }}
        run: |
          curl -sS -X POST -H "Content-Type: application/json" \
            -d @payload.json "${{ steps.route.outputs.webhook }}"
